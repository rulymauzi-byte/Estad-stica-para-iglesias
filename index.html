<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema Estad√≠stico CEGIC</title>
    <style>
        :root {
            --primary: #2c3e50;
            --accent: #27ae60;
            --light: #ecf0f1;
            --border: #bdc3c7;
        }
        body { font-family: 'Segoe UI', sans-serif; background-color: #f4f7f6; margin: 0; padding: 15px; }
        
        .container { max-width: 98%; margin: 0 auto; background: white; padding: 20px; border-radius: 8px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); position: relative; }
        
        /* MARCA DE AGUA RAMAUZI */
        .marca-ramauzi {
            position: absolute;
            top: 10px;
            right: 15px;
            font-family: 'Brush Script MT', 'Cursive', cursive; /* Letra cursiva */
            font-size: 0.9rem;
            color: #bdc3c7;
            pointer-events: none; /* Para que no estorbe al clic */
        }

        /* CONTACTO HEADER */
        .contacto-box {
            background-color: #eaf2f8;
            border: 1px solid #d6eaf8;
            padding: 10px;
            border-radius: 5px;
            text-align: center;
            margin-bottom: 20px;
        }
        .contacto-titulo { font-size: 0.85rem; color: #555; margin-bottom: 5px; }
        .contacto-numero { font-size: 1.1rem; font-weight: bold; color: #2980b9; text-decoration: none; display: block; margin-bottom: 2px;}
        .contacto-nombre { font-size: 0.75rem; color: #7f8c8d; font-style: italic; }

        /* BOTONES MENU */
        .btn-consejo {
            width: 100%; padding: 20px; margin-bottom: 15px;
            background: #ffffff; border-left: 10px solid var(--accent);
            border-top: 1px solid #eee; border-right: 1px solid #eee; border-bottom: 1px solid #eee;
            font-size: 1.2rem; text-align: left; cursor: pointer;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05); transition: 0.3s;
        }
        .btn-consejo:hover { transform: translateX(5px); background: #f9fff9; }
        
        .btn-crear { background: var(--primary); color: white; border: none; padding: 15px; width: 100%; border-radius: 5px; cursor: pointer; margin-top: 10px; font-weight: bold; font-size: 1rem;}
        .btn-ver-pass { background: #95a5a6; color: white; border: none; padding: 10px; width: 100%; border-radius: 5px; cursor: pointer; margin-top: 10px; font-size: 0.8rem;}

        /* FORMULARIOS */
        #pantalla-formulario { display: none; }
        .seccion-titulo { background: #e8f5e9; padding: 10px; margin: 25px 0 15px 0; font-weight: bold; color: var(--accent); border-bottom: 2px solid var(--accent); text-transform: uppercase; letter-spacing: 1px; }
        
        .grid-2 { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; }
        @media (max-width: 600px) { .grid-2 { grid-template-columns: 1fr; } }

        label { display: block; font-weight: 600; margin-bottom: 5px; font-size: 0.85rem; color: #555; }
        
        input, select, textarea { width: 100%; padding: 10px; border: 1px solid #ccc; border-radius: 4px; box-sizing: border-box; font-family: inherit; }
        input:focus, textarea:focus { border-color: var(--accent); outline: none; }
        ::placeholder { color: #aaa; font-style: italic; }

        /* BOTONES ACCI√ìN */
        .btn-enviar { background: var(--accent); color: white; border: none; padding: 15px; width: 100%; border-radius: 5px; font-size: 1.1rem; cursor: pointer; margin-top: 20px; font-weight: bold;}
        .btn-volver { background: #7f8c8d; color: white; padding: 8px 15px; border: none; border-radius: 4px; cursor: pointer; margin-bottom: 15px; font-size: 0.9rem;}
        
        /* TABLA */
        .contenedor-tabla { margin-top: 40px; overflow-x: auto; border-top: 5px solid var(--primary); padding-top: 20px; }
        table { width: 100%; border-collapse: collapse; font-size: 0.7rem; min-width: 2200px; }
        th { background-color: #90ee90; border: 1px solid #333; padding: 8px; color: black; text-transform: uppercase; position: sticky; top: 0; z-index: 2;}
        td { border: 1px solid #999; padding: 6px; text-align: center; color: #333; vertical-align: top;}
        tr:nth-child(even) { background-color: #f8f9fa; }
        .link-tel { color: #2980b9; text-decoration: none; font-weight: bold; }
        
        tfoot tr { background-color: #e0e0e0; color: black; font-weight: bold; border-top: 2px solid black;}
        tfoot td { border: 1px solid #666; padding: 10px 5px; font-size: 0.85rem;}

        /* MODAL Y STATUS */
        #modal-nuevo { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); justify-content: center; align-items: center; z-index: 100;}
        .modal-content { background: white; padding: 30px; border-radius: 8px; width: 90%; max-width: 400px; text-align: center; }
        
        .status-bar { padding: 10px; text-align: center; color: white; font-weight: bold; margin-bottom: 15px; border-radius: 4px; display: none; }
        .offline { background: #e67e22; }
        .sync-active { background: #27ae60; }

    </style>
</head>
<body>

<div class="container">
    <div class="marca-ramauzi">Creado por Ramauzi</div>
    <div id="status-bar" class="status-bar"></div>

    <div id="pantalla-inicio">
        <h1 style="text-align: center; color: var(--primary); margin-top: 25px;">Estad√≠sticas Regionales CEGIC</h1>
        
        <div class="contacto-box">
            <div class="contacto-titulo">¬øTienes dudas de c√≥mo manejar el sistema? Ll√°manos:</div>
            <a href="tel:55258033" class="contacto-numero">üìû 5525-8033</a>
            <div class="contacto-nombre">Pastor Ra√∫l Mart√≠n</div>
        </div>

        <div id="lista-botones"></div>
        
        <button class="btn-crear" onclick="mostrarModal()">+ Agregar Nuevo Consejo Regional</button>
        <button class="btn-ver-pass" onclick="verContrasenas()">üîê Administrar Contrase√±as</button>
    </div>

    <div id="pantalla-formulario">
        <div style="display:flex; justify-content:space-between; align-items:center;">
            <button class="btn-volver" onclick="volver()">‚Üê Volver al Men√∫</button>
            <div class="marca-ramauzi" style="position:static; margin-bottom:10px;">Creado por Ramauzi</div>
        </div>
        
        <h2 id="titulo-consejo" style="margin-top:0;">Formulario</h2>
        
        <div class="contacto-box" style="background-color:#fff8e1; border-color:#ffe0b2;">
            <div class="contacto-titulo">Si tienes dudas sobre el formulario, llama al encargado:</div>
            <a href="#" id="link-encargado" class="contacto-numero">Cargando...</a>
            <div class="contacto-nombre">Encargado del Consejo</div>
        </div>

        <form id="form-datos" onsubmit="guardarDatos(event)">
            
            <div class="seccion-titulo">1. Datos Generales</div>
            <div class="grid-2">
                <div><label>Nombre Iglesia:</label><input type="text" name="nombreIglesia" required></div>
                <div><label>Direcci√≥n:</label><input type="text" name="direccion"></div>
                <div><label>Correo Electr√≥nico:</label><input type="email" name="email"></div>
                <div>
                    <label>Tel√©fono / Celular:</label>
                    <input type="tel" name="telefono" 
                           placeholder="502 Pastor o Presidente" 
                           oninput="this.value = this.value.replace(/[^0-9+ ]/g, '')">
                </div>
            </div>

            <div class="seccion-titulo">2. Membres√≠a</div>
            <div class="grid-2">
                <div style="background: #e8f8f5; padding:5px; border-radius:4px; border:1px dashed var(--accent);">
                    <label style="color:var(--accent)">‚òÖ ¬øCu√°ntos convertidos este a√±o?</label>
                    <input type="number" name="convertidos" placeholder="0">
                </div>
                <div><label>Miembros Bautizados:</label><input type="number" name="bautizados" placeholder="0"></div>
                <div><label>No Bautizados:</label><input type="number" name="noBautizados" placeholder="0"></div>
                <div><label>Total Miembros (Incl. congregaciones):</label><input type="number" name="totalMiembros" placeholder="0"></div>
            </div>
            
            <div class="grid-2" style="margin-top:10px">
                <div>
                    <label>Nombre de todas sus congregaciones:</label>
                    <textarea name="congregaciones" rows="4" placeholder="Escriba una por l√≠nea..."></textarea>
                </div>
                <div>
                    <label>Campos Blancos / Casas visita:</label>
                    <textarea name="camposBlancos" rows="4" placeholder="Escriba una por l√≠nea..."></textarea>
                </div>
            </div>

            <div class="seccion-titulo">3. Oficiales</div>
            <div class="grid-2">
                <div><label>Ancianos:</label><input type="number" name="ancianos" placeholder="0"></div>
                <div><label>Di√°conos:</label><input type="number" name="diaconos" placeholder="0"></div>
                <div><label>Diaconisas:</label><input type="number" name="diaconisas" placeholder="0"></div>
            </div>

            <div class="seccion-titulo">4. Por Edades y G√©nero</div>
            <div class="grid-2">
                <div><label>Ni√±os (1-11 a√±os):</label><input type="number" name="ninos" placeholder="0"></div>
                <div><label>Adolescentes (12-17 a√±os):</label><input type="number" name="adolescentes" placeholder="0"></div>
                <div><label>J√≥venes Solteros (18-30 a√±os):</label><input type="number" name="jovenes" placeholder="0"></div>
                <div><label>Hombres en total:</label><input type="number" name="hombres" placeholder="0"></div>
                <div><label>Mujeres en total:</label><input type="number" name="mujeres" placeholder="0"></div>
            </div>

            <div class="seccion-titulo">5. Ministerios y Medios</div>
            <div class="grid-2">
                <div><label>Tiene Soc. de J√≥venes</label><select name="socJovenes"><option>Si</option><option>No</option></select></div>
                <div><label>Tiene Soc. de Damas</label><select name="socDamas"><option>Si</option><option>No</option></select></div>
                <div><label>Tiene Soc. de Caballeros</label><select name="socCaballeros"><option>Si</option><option>No</option></select></div>
                <div><label>Tiene Ministerio Infantil</label><select name="minInfantil"><option>Si</option><option>No</option></select></div>
                <div><label>MEDIOS (Si tiene TV o Radio):</label><input type="text" name="medios" placeholder="Especifique"></div>
            </div>

            <button type="submit" class="btn-enviar" id="btn-submit">GUARDAR REPORTE</button>
        </form>

        <div class="contenedor-tabla">
            <h3 style="text-align:center;">Reporte Global: <span id="nombre-tabla-local"></span></h3>
            <p style="text-align:center; font-size:0.8rem;">Deslice para ver todo. Toque el n√∫mero para llamar.</p>
            <table id="tabla-registros">
                <thead>
                    <tr>
                        <th>Iglesia</th><th>Direcci√≥n</th><th>Email</th><th>Tel√©fono</th>
                        <th>Convertidos</th><th>Bautizados</th><th>No Baut.</th><th>TOTAL MIEM.</th>
                        <th>Congregaciones</th><th>C. Blancos</th>
                        <th>Ancianos</th><th>Di√°conos</th><th>Diaconisas</th>
                        <th>Ni√±os</th><th>Adolesc.</th><th>J√≥venes</th><th>Hombres</th><th>Mujeres</th>
                        <th>S.J√≥v</th><th>S.Dama</th><th>S.Cab</th><th>M.Inf</th>
                        <th>MEDIOS</th><th>Estado</th>
                    </tr>
                </thead>
                <tbody></tbody>
                <tfoot><tr id="fila-totales"></tr></tfoot>
            </table>
        </div>
    </div>
</div>

<div id="modal-nuevo">
    <div class="modal-content">
        <h3 style="color:var(--primary)">Nuevo Consejo Regional</h3>
        <label style="text-align:left">Clave Maestra:</label>
        <input type="password" id="admin-pass" placeholder="CEGIC_2026" style="margin-bottom:15px; border-color: red;">
        <hr style="border:0; border-top:1px solid #eee; margin:15px 0;">
        <label style="text-align:left">Nombre Consejo:</label>
        <input type="text" id="new-name" placeholder="Ej. Zona Sur" style="margin-bottom:10px">
        <label style="text-align:left">N√∫mero del Encargado (Para dudas):</label>
        <input type="tel" id="new-phone" placeholder="Ej. 5555-5555" style="margin-bottom:10px">
        <label style="text-align:left">Crear Contrase√±a:</label>
        <input type="password" id="new-pass" placeholder="Contrase√±a de acceso">
        <button class="btn-enviar" onclick="crearConsejo()">Crear</button>
        <button class="btn-volver" onclick="cerrarModal()" style="margin-top:10px; width:100%">Cancelar</button>
    </div>
</div>

<script>
    // --- CONFIGURACI√ìN ---
    // PEGA AQU√ç TU URL DE GOOGLE APPS SCRIPT
    const API_URL = "https://script.google.com/macros/s/AKfycbzL3BNCa3X-3bMTrST9ej6djGtfUYKQA9878c3P8JrCsIsD_Axp1UCFcOOe-IL9vob3Vw/exec";

    // DATOS INICIALES (Incluye tel√©fono de Akateko por defecto)
    let consejos = JSON.parse(localStorage.getItem('consejos_v6')) || [
        { nombre: "Consejo Regional Akateko", pass: "cerak1", phone: "45139701" }
    ];

    let consejoActivo = null;
    let consejoActivoObj = null; // Guardamos el objeto completo para tener el telefono
    let cola = JSON.parse(localStorage.getItem('cola_envios_v6')) || [];
    let historial = JSON.parse(localStorage.getItem('historial_v6')) || [];

    document.addEventListener("DOMContentLoaded", () => {
        renderBotones();
        checkInternet();
    });

    function renderBotones() {
        const div = document.getElementById('lista-botones');
        div.innerHTML = "";
        consejos.forEach(c => {
            let btn = document.createElement('button');
            btn.className = "btn-consejo";
            btn.innerHTML = `üèõÔ∏è <b>${c.nombre}</b>`;
            btn.onclick = () => login(c.nombre, c.pass);
            div.appendChild(btn);
        });
    }

    function login(nombre, passReal) {
        let input = prompt(`Ingrese contrase√±a para: ${nombre}`);
        if (input === passReal) {
            consejoActivo = nombre;
            // Buscar objeto para sacar el telefono
            consejoActivoObj = consejos.find(c => c.nombre === nombre);
            
            // UI Update
            document.getElementById('pantalla-inicio').style.display = 'none';
            document.getElementById('pantalla-formulario').style.display = 'block';
            document.getElementById('titulo-consejo').innerText = nombre;
            document.getElementById('nombre-tabla-local').innerText = nombre;
            
            // Actualizar tel√©fono din√°mico del encargado
            const linkTel = document.getElementById('link-encargado');
            let phoneNum = consejoActivoObj.phone || "Sin n√∫mero";
            linkTel.innerText = `üìû ${phoneNum}`;
            linkTel.href = `tel:${phoneNum}`;

            window.scrollTo(0,0);
            
            // Descargar y sincronizar (borra datos si se borraron en Sheets)
            descargarDatosNube();
            renderTabla(); 
        } else {
            alert("Contrase√±a incorrecta");
        }
    }

    function volver() {
        document.getElementById('pantalla-formulario').style.display = 'none';
        document.getElementById('pantalla-inicio').style.display = 'block';
        document.getElementById('form-datos').reset();
        consejoActivo = null;
    }

    // --- GESTI√ìN DE CONTRASE√ëAS ---
    function verContrasenas() {
        let master = prompt("Ingrese la Contrase√±a Maestra:");
        if (master === "Raulmartin12") {
            let mensaje = "CONSEJOS REGISTRADOS:\n\n";
            consejos.forEach(c => {
                mensaje += `üèõÔ∏è ${c.nombre}\nüîë Clave: ${c.pass}\nüìû Encargado: ${c.phone || 'N/A'}\n\n`;
            });
            alert(mensaje);
        } else {
            alert("Acceso denegado.");
        }
    }

    function mostrarModal() { 
        document.getElementById('modal-nuevo').style.display = 'flex'; 
        document.getElementById('admin-pass').value = ""; 
    }
    function cerrarModal() { document.getElementById('modal-nuevo').style.display = 'none'; }

    function crearConsejo() {
        const adminPass = document.getElementById('admin-pass').value;
        const nombre = document.getElementById('new-name').value;
        const pass = document.getElementById('new-pass').value;
        const phone = document.getElementById('new-phone').value; // Nuevo campo

        if(adminPass !== "CEGIC_2026") { alert("‚õî Contrase√±a maestra incorrecta."); return; }

        if(nombre && pass && phone) {
            consejos.push({nombre: nombre, pass: pass, phone: phone});
            localStorage.setItem('consejos_v6', JSON.stringify(consejos));
            renderBotones();
            cerrarModal();
            alert("Consejo creado exitosamente.");
        } else {
            alert("Por favor llene todos los campos, incluido el tel√©fono del encargado.");
        }
    }

    // --- GUARDAR ---
    function guardarDatos(e) {
        e.preventDefault();
        const form = new FormData(e.target);
        const data = Object.fromEntries(form.entries());
        
        data.consejo = consejoActivo; 
        data.id = Date.now();
        data.enviado = false;

        historial.push(data);
        localStorage.setItem('historial_v6', JSON.stringify(historial));

        if(navigator.onLine) {
            enviarNube(data);
        } else {
            cola.push(data);
            localStorage.setItem('cola_envios_v6', JSON.stringify(cola));
            checkInternet();
            alert("Guardado OFFLINE. Se subir√° autom√°ticamente cuando haya internet.");
            renderTabla();
            document.getElementById('form-datos').reset();
        }
    }

    function enviarNube(data) {
        const btn = document.getElementById('btn-submit');
        btn.textContent = "Subiendo...";
        btn.disabled = true;

        fetch(API_URL, {
            method: 'POST', mode: 'no-cors',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify(data)
        }).then(() => {
            // Marcamos como enviado
            const index = historial.findIndex(h => h.id === data.id);
            if(index !== -1) { 
                historial[index].enviado = true; 
                localStorage.setItem('historial_v6', JSON.stringify(historial));
            }
            if(document.getElementById('form-datos')) document.getElementById('form-datos').reset();
            
            // IMPORTANTE: Al enviar, sincronizamos completo para reflejar cambios
            descargarDatosNube();
        }).catch(e => {
            console.error(e);
            cola.push(data);
            localStorage.setItem('cola_envios_v6', JSON.stringify(cola));
        }).finally(() => {
            if(document.getElementById('btn-submit')) {
                document.getElementById('btn-submit').textContent = "GUARDAR REPORTE";
                document.getElementById('btn-submit').disabled = false;
            }
            renderTabla();
            checkInternet();
        });
    }

    // --- SINCRONIZACI√ìN ESPEJO (Borra locales si no est√°n en nube) ---
    function descargarDatosNube() {
        if(!navigator.onLine || !consejoActivo) return;

        const urlConParams = API_URL + "?consejo=" + encodeURIComponent(consejoActivo);

        fetch(urlConParams)
        .then(response => response.json())
        .then(datosNube => {
            if(datosNube) {
                // 1. Filtramos los datos de OTROS consejos (esos no se tocan)
                let otrosConsejos = historial.filter(h => h.consejo !== consejoActivo);
                
                // 2. Filtramos los datos LOCALES NUEVOS que a√∫n NO se han enviado a la nube (esos se guardan)
                let localesPendientes = historial.filter(h => h.consejo === consejoActivo && !h.enviado);

                // 3. Preparamos los datos de la nube
                datosNube.forEach(d => {
                    d.consejo = consejoActivo;
                    d.enviado = true;
                    // Generamos un ID si no trae, para estabilidad de la tabla
                    d.id = d.id || (d.nombreIglesia + d.totalMiembros); 
                });

                // 4. REEMPLAZO TOTAL: El nuevo historial es: 
                // [Otros consejos] + [Lo que diga la Nube (La Verdad)] + [Lo que tengo pendiente de subir]
                historial = [...otrosConsejos, ...datosNube, ...localesPendientes];
                
                localStorage.setItem('historial_v6', JSON.stringify(historial));
                renderTabla();
                console.log("Sincronizaci√≥n espejo completada.");
            }
        })
        .catch(e => console.error("Error sync:", e));
    }

    // --- TABLA ---
    function renderTabla() {
        const tbody = document.querySelector('#tabla-registros tbody');
        const tfoot = document.getElementById('fila-totales');
        tbody.innerHTML = "";
        
        const datos = historial.filter(h => h.consejo === consejoActivo);
        
        let sum = { conv:0, baut:0, noBaut:0, total:0, anc:0, diac:0, diaconisa:0, ninos:0, adol:0, jov:0, hom:0, muj:0 };

        datos.forEach(d => {
            sum.conv += Number(d.convertidos)||0;
            sum.baut += Number(d.bautizados)||0;
            sum.noBaut += Number(d.noBautizados)||0;
            sum.total += Number(d.totalMiembros)||0;
            sum.anc += Number(d.ancianos)||0;
            sum.diac += Number(d.diaconos)||0;
            sum.diaconisa += Number(d.diaconisas)||0;
            sum.ninos += Number(d.ninos)||0;
            sum.adol += Number(d.adolescentes)||0;
            sum.jov += Number(d.jovenes)||0;
            sum.hom += Number(d.hombres)||0;
            sum.muj += Number(d.mujeres)||0;

            let listaCong = (d.congregaciones || "").replace(/\n/g, "<br>");
            let listaCampos = (d.camposBlancos || "").replace(/\n/g, "<br>");
            let telDisplay = d.telefono ? `<a href="tel:${d.telefono}" class="link-tel">üìû ${d.telefono}</a>` : '-';

            let row = `<tr>
                <td style="font-weight:bold">${d.nombreIglesia}</td>
                <td>${d.direccion || '-'}</td>
                <td>${d.email || '-'}</td>
                <td>${telDisplay}</td>
                <td style="background:#e8f8f5">${d.convertidos || ''}</td>
                <td>${d.bautizados || ''}</td>
                <td>${d.noBautizados || ''}</td>
                <td style="font-weight:bold">${d.totalMiembros || ''}</td>
                <td style="text-align:left; font-size:0.6rem">${listaCong}</td>
                <td style="text-align:left; font-size:0.6rem">${listaCampos}</td>
                <td>${d.ancianos || ''}</td>
                <td>${d.diaconos || ''}</td>
                <td>${d.diaconisas || ''}</td>
                <td>${d.ninos || ''}</td>
                <td>${d.adolescentes || ''}</td>
                <td>${d.jovenes || ''}</td>
                <td>${d.hombres || ''}</td>
                <td>${d.mujeres || ''}</td>
                <td>${d.socJovenes}</td>
                <td>${d.socDamas}</td>
                <td>${d.socCaballeros}</td>
                <td>${d.minInfantil}</td>
                <td style="background:#fff3e0">${d.medios || '-'}</td>
                <td style="color:${d.enviado?'green':'red'}; font-weight:bold">${d.enviado?'OK':'PEND'}</td>
            </tr>`;
            tbody.innerHTML += row;
        });

        tfoot.innerHTML = `
            <td>TOTALES</td><td>-</td><td>-</td><td>-</td>
            <td>${sum.conv}</td><td>${sum.baut}</td><td>${sum.noBaut}</td><td>${sum.total}</td>
            <td>-</td><td>-</td>
            <td>${sum.anc}</td><td>${sum.diac}</td><td>${sum.diaconisa}</td>
            <td>${sum.ninos}</td><td>${sum.adol}</td><td>${sum.jov}</td><td>${sum.hom}</td><td>${sum.muj}</td>
            <td>-</td><td>-</td><td>-</td><td>-</td><td>-</td><td>-</td>
        `;
    }

    // --- AUTO SYNC ---
    function checkInternet() {
        const bar = document.getElementById('status-bar');
        if (navigator.onLine) {
            if (cola.length > 0) {
                bar.style.display = 'block';
                bar.className = 'status-bar sync-active';
                bar.innerHTML = `üîÑ Internet detectado. Subiendo ${cola.length} pendientes...`;
                sincronizar(); 
            } else {
                bar.style.display = 'none';
            }
        } else {
            bar.style.display = 'block';
            bar.className = 'status-bar offline';
            bar.innerHTML = `‚ö†Ô∏è SIN CONEXI√ìN (${cola.length} pendientes)`;
        }
    }

    function sincronizar() {
        if(cola.length === 0) return;
        const dato = cola[0];
        fetch(API_URL, {
            method: 'POST', mode: 'no-cors',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify(dato)
        }).then(() => {
            cola.shift();
            localStorage.setItem('cola_envios_v6', JSON.stringify(cola));
            
            let found = historial.find(h => h.id === dato.id);
            if(found) found.enviado = true;
            localStorage.setItem('historial_v6', JSON.stringify(historial));
            
            renderTabla();
            
            if(cola.length > 0) {
                sincronizar();
            } else {
                checkInternet();
                descargarDatosNube(); // Actualizar final
            }
        }).catch(e => console.log("Reintentando..."));
    }

    window.addEventListener('online', checkInternet);
    window.addEventListener('offline', checkInternet);

</script>
</body>
</html>