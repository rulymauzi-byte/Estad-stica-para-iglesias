<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema Estad√≠stico CEGIC</title>
    <style>
        :root { 
            --bg-dorado-soft: linear-gradient(135deg, #fdfaf5 0%, #e5d5b0 100%); 
            --dorado-metal: #d4af37;
            --dorado-oscuro: #b8860b;
            --negro-borde: #1a1a1a;
            --verde-proceso: #27ae60;
            --danger: #e74c3c;
            --text-dark: #2c3e50;
        }
        
        body { font-family: 'Segoe UI', sans-serif; background: var(--bg-dorado-soft); background-attachment: fixed; color: var(--text-dark); margin: 0; padding: 0; }

        #barra-proceso {
            display: none; background-color: var(--verde-proceso); color: white;
            text-align: center; padding: 8px; font-weight: bold; font-size: 0.9rem;
            width: 100%; position: fixed; top: 0; left: 0; z-index: 1000;
            animation: parpadeo-verde 1s infinite;
        }
        @keyframes parpadeo-verde { 0% { opacity: 1; } 50% { opacity: 0.6; } 100% { opacity: 1; } }

        #encabezado-principal {
            position: sticky; top: 0; z-index: 100;
            background: #ffffff; padding: 15px; border-bottom: 4px solid var(--dorado-metal); text-align: center;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .main-title { margin: 10px 0 0 0; font-size: 1.6rem; color: var(--negro-borde); letter-spacing: 1px; font-weight: 800; }
        .sub-title { margin: 5px 0; font-size: 0.8rem; color: var(--dorado-oscuro); text-transform: uppercase; font-weight: bold; }

        .selector-gestion {
            background: white; color: var(--dorado-oscuro); border: 2px solid var(--dorado-metal);
            padding: 8px 15px; border-radius: 5px; font-weight: bold; margin: 10px 0;
            cursor: pointer; outline: none;
        }

        .container { max-width: 98%; margin: 10px auto; padding: 10px; }
        .marca-raumauzi { font-weight: bold; text-transform: uppercase; font-size: 0.75rem; color: var(--negro-borde); text-align: right; margin-bottom: 10px; }

        .btn-consejo { 
            width: 100%; padding: 18px; margin-bottom: 12px; 
            background: linear-gradient(135deg, #d4af37 0%, #b8860b 100%); 
            border: 2px solid var(--negro-borde); color: white; 
            text-align: left; cursor: pointer; border-radius: 8px; font-weight: bold; font-size: 1.1rem;
            transition: transform 0.3s ease;
        }

        .informe-box { background: white; border: 2px solid var(--dorado-metal); border-radius: 8px; margin: 20px 0; overflow: hidden; }
        .informe-header { background: var(--negro-borde); color: var(--dorado-metal); padding: 15px; cursor: pointer; display: flex; justify-content: space-between; align-items: center; }
        .informe-content { padding: 20px; display: none; background: white; }
        .grid-informe { display: grid; grid-template-columns: repeat(auto-fit, minmax(130px, 1fr)); gap: 10px; text-align: center; }
        .dato-card { background: #fffcf5; padding: 10px; border: 1px solid #ddd; border-bottom: 3px solid var(--verde-proceso); border-radius: 5px; }
        .dato-val { font-size: 1.4rem; font-weight: bold; color: var(--dorado-oscuro); display: block; }
        .dato-lab { font-size: 0.7rem; text-transform: uppercase; color: #555; font-weight: bold; }

        .seccion-titulo { background: var(--negro-borde); color: var(--dorado-metal); padding: 10px; margin: 25px 0 15px 0; font-weight: bold; text-transform: uppercase; }
        .alerta-min-mayuscula { color: var(--danger); font-size: 0.75rem; display: block; margin-top: 2px; font-weight: 800; letter-spacing: 0.5px; }
        
        input, select, textarea { background: white; color: var(--negro-borde); border: 1px solid var(--dorado-metal); padding: 12px; width: 100%; box-sizing: border-box; border-radius: 4px; margin-bottom: 10px;}
        .btn-enviar { background: var(--dorado-metal); color: white; border: 2px solid var(--negro-borde); padding: 18px; width: 100%; border-radius: 5px; font-weight: bold; cursor: pointer; font-size: 1.1rem; }
        .btn-enviar:disabled { background: #ccc; color: #777; cursor: not-allowed; }

        .contenedor-tabla { margin-top: 30px; overflow-x: auto; }
        table { width: 100%; border-collapse: collapse; font-size: 0.75rem; min-width: 4200px; color: var(--negro-borde); background: white; }
        th { background: var(--negro-borde); color: var(--dorado-metal); padding: 10px; border: 1px solid #444; }
        td { border: 1px solid var(--dorado-metal); padding: 6px; text-align: center; }
        tfoot tr { background-color: #f2f2f2; font-weight: bold; border-top: 2px solid var(--negro-borde); }

        #pantalla-formulario { display: none; }
    </style>
</head>
<body>

<div id="barra-proceso">TRABAJANDO...</div>

<div id="encabezado-principal">
    <h1 class="main-title">ESTAD√çSTICAS CEGIC</h1>
    <div class="sub-title">Consejo Evang√©lico General de la Iglesia Centroamericana</div>
    
    <div style="font-weight: bold;">
        ESTADISTICA: <select id="selector-anio" class="selector-gestion" onchange="cambiarAnio()"></select>
    </div>

    <div id="box-asistencia-principal" style="margin-top: 10px;">
        <a href="tel:55258033" style="color: var(--dorado-oscuro); text-decoration: none; font-weight: 800; border: 2px solid var(--dorado-metal); padding: 5px 15px; border-radius: 5px; background: white; display: inline-block;">üìû ASISTENCIA: 5525-8033</a>
    </div>
</div>

<div class="container">
    <div class="marca-raumauzi">RAUMAUZI</div>

    <div id="pantalla-inicio">
        <div id="lista-botones"></div>

        <div class="informe-box">
            <div class="informe-header" onclick="toggleInforme()">
                <span style="font-weight:bold;">üëÅÔ∏è INFORME GENERAL CEGIC (<span class="anio-actual-txt"></span>)</span>
                <span id="ojo-icono">VER DATOS ‚ñΩ</span>
            </div>
            <div id="informe-content" class="informe-content">
                <div class="grid-informe">
                    <div class="dato-card"><span class="dato-val" id="inf-iglesias">0</span><span class="dato-lab">Iglesias</span></div>
                    <div class="dato-card"><span class="dato-val" id="inf-congregaciones">0</span><span class="dato-lab">Congregaciones</span></div>
                    <div class="dato-card"><span class="dato-val" id="inf-miembros">0</span><span class="dato-lab">Miembros</span></div>
                    <div class="dato-card"><span class="dato-val" id="inf-convertidos">0</span><span class="dato-lab">Convertidos</span></div>
                    <div class="dato-card"><span class="dato-val" id="inf-bautizados">0</span><span class="dato-lab">Bautizados</span></div>
                    <div class="dato-card"><span class="dato-val" id="inf-ancianos">0</span><span class="dato-lab">Ancianos</span></div>
                    <div class="dato-card"><span class="dato-val" id="inf-diaconos">0</span><span class="dato-lab">Di√°conos</span></div>
                    <div class="dato-card"><span class="dato-val" id="inf-diaconisas">0</span><span class="dato-lab">Diaconisas</span></div>
                    <div class="dato-card"><span class="dato-val" id="inf-hombres">0</span><span class="dato-lab">Hombres</span></div>
                    <div class="dato-card"><span class="dato-val" id="inf-mujeres">0</span><span class="dato-lab">Mujeres</span></div>
                </div>
            </div>
        </div>
        
        <button onclick="mostrarModal()" style="width:100%; padding:15px; background:white; border:2px solid var(--dorado-metal); color:var(--dorado-oscuro); cursor:pointer; border-radius:5px; font-weight: bold;">+ AGREGAR NUEVO CONSEJO REGIONAL</button>
    </div>

    <div id="pantalla-formulario">
        <button onclick="volver()" style="background:var(--negro-borde); color:white; border:none; padding:10px 15px; border-radius:4px; cursor:pointer; margin-bottom:15px; font-weight: bold;">‚Üê VOLVER AL MEN√ö</button>
        <h2 id="titulo-consejo" style="margin:0; color:var(--dorado-oscuro);"></h2>

        <div id="box-contacto-encargado" style="background: white; border: 2px solid var(--dorado-metal); padding: 10px; border-radius: 5px; margin: 15px 0;">
            <div style="font-size:0.8rem; color: #555; font-weight: bold;">PARA DUDAS SOBRE ESTE CONSEJO, LLAME AL ENCARGADO:</div>
            <a href="#" id="link-encargado" style="color: var(--dorado-oscuro); text-decoration: none; font-weight: 800; font-size: 1.2rem;">üìû Cargando...</a>
        </div>

        <div id="aviso-bloqueo" style="display:none; color: var(--danger); background: #feeae6; padding: 10px; border: 2px solid var(--danger); border-radius: 5px; margin-bottom: 15px; text-align: center; font-weight: bold;">
            ‚ö†Ô∏è ADVERTENCIA: Solo se pueden ingresar datos si es el a√±o actual (<span id="span-anio-actual"></span>).
        </div>
        
        <form id="form-datos" onsubmit="guardarDatos(event)">
            <div class="seccion-titulo">1. Identificaci√≥n</div>
            <div style="display:grid; grid-template-columns:1fr 1fr; gap:15px;">
                <div>
                    <label style="color:var(--danger); font-weight:bold; font-size:0.8rem;">‚ö†Ô∏è SELECCIONAR OBLIGATORIO: Iglesia o Congregaci√≥n</label>
                    <select name="tipoEntidad" id="tipoEntidad" style="border:2px solid var(--danger); font-weight:bold;" required>
                        <option value="" disabled selected>-- SELECCIONE AQU√ç --</option>
                        <option value="Iglesia">IGLESIA OFICIAL</option>
                        <option value="Congregacion">CONGREGACI√ìN</option>
                    </select>
                </div>
                <div><label>Nombre:</label><input type="text" name="nombreIglesia" required placeholder="Escriba el nombre aqu√≠..."></div>
            </div>
            <div style="display:grid; grid-template-columns:1fr 1fr 1fr; gap:15px;">
                <input type="text" name="direccion" placeholder="Direcci√≥n">
                <input type="email" name="email" placeholder="Email">
                <input type="tel" name="telefono" placeholder="Tel√©fono Iglesia">
            </div>

            <div class="seccion-titulo">2. Membres√≠a</div>
            <div style="display:grid; grid-template-columns:repeat(4, 1fr); gap:10px;">
                <div><label>Convertidos este a√±o</label><input type="number" name="convertidos"></div>
                <div><label>Bautizados</label><input type="number" name="bautizados"></div>
                <div><label>No Bautizados</label><input type="number" name="noBautizados"></div>
                <div><label>Total Miembros</label><input type="number" name="totalMiembros"></div>
            </div>
            <div style="display:grid; grid-template-columns:1fr 1fr; gap:15px; margin-top:10px;">
                <textarea name="congregaciones" placeholder="Si tiene congregaciones escribe los nombres..." rows="3"></textarea>
                <textarea name="camposBlancos" placeholder="Si tiene Campos Blancos escribe los nombres..." rows="3"></textarea>
            </div>

            <div class="seccion-titulo">3. Oficiales y G√©nero</div>
            <div style="display:grid; grid-template-columns:repeat(5, 1fr); gap:10px;">
                <div><label>Ancianos</label><input type="number" name="ancianos"></div>
                <div><label>Di√°conos</label><input type="number" name="diaconos"></div>
                <div><label>Diaconisas</label><input type="number" name="diaconisas"></div>
                <div><label>Hombres</label><input type="number" name="hombres"></div>
                <div><label>Mujeres</label><input type="number" name="mujeres"></div>
            </div>

            <div class="seccion-titulo">4. Distribuci√≥n por Edades</div>
            <div style="display:grid; grid-template-columns:repeat(3, 1fr); gap:15px;">
                <div><label>Ni√±os (1-11 a√±os)</label><input type="number" name="ninos"></div>
                <div><label>Adolescentes (12-17 a√±os)</label><input type="number" name="adolescentes"></div>
                <div><label>J√≥venes (18-30 a√±os)</label><input type="number" name="jovenes"></div>
            </div>

            <div class="seccion-titulo">5. Sociedades y Ministerios (OBLIGATORIO)</div>
            <div style="display:grid; grid-template-columns:1fr 1fr; gap:15px;">
                <div>
                    <label>¬øHay Sociedad Femenil?</label>
                    <select name="socFemenil" required>
                        <option value="" disabled selected>-- SELECCIONE --</option>
                        <option value="Si">Si</option><option value="No">No</option>
                    </select>
                </div>
                <div>
                    <label>¬øHay Sociedad Juvenil?</label>
                    <select name="socJuvenil" required>
                        <option value="" disabled selected>-- SELECCIONE --</option>
                        <option value="Si">Si</option><option value="No">No</option>
                    </select>
                </div>
            </div>
            <div style="display:grid; grid-template-columns:1fr 1fr; gap:15px; margin-top:10px;">
                <div>
                    <label>¬øHay Sociedad de Caballero?</label>
                    <select name="socCaballero" required>
                        <option value="" disabled selected>-- SELECCIONE --</option>
                        <option value="Si">Si</option><option value="No">No</option>
                    </select>
                </div>
                <div>
                    <label>¬øHay Ministerio Infantil?</label>
                    <span class="alerta-min-mayuscula">ES IMPORTANTE ESTE MINISTERIO</span>
                    <select name="minInfantil" id="minInfantil" required>
                        <option value="" disabled selected>-- SELECCIONE (Si/No) --</option>
                        <option value="Si">Si</option><option value="No">No</option>
                    </select>
                </div>
            </div>
            <div style="margin-top:10px;">
                <label>Nombre del Ministerio Infantil (opcional):</label>
                <input type="text" name="nombreMinInfantil" placeholder="Escriba el nombre si tiene...">
            </div>

            <div class="seccion-titulo">6. Otros</div>
            <input type="text" name="medios" placeholder="Medios que utiliza la Iglesia (TV/Radio/Redes)...">

            <button type="submit" class="btn-enviar" id="btn-submit">GUARDAR REPORTE <span class="anio-actual-txt"></span></button>
        </form>

        <div class="contenedor-tabla">
            <h3 style="color:var(--negro-borde); border-bottom: 2px solid var(--dorado-metal);">HISTORIAL COMPLETO: <span id="nombre-tabla-local"></span> (<span class="anio-actual-txt"></span>)</h3>
            <table id="tabla-registros">
                <thead>
                    <tr>
                        <th>Acci√≥n</th><th>Tipo</th><th>Nombre</th><th>Dir.</th><th>Tel.</th>
                        <th>Conv.</th><th>Baut.</th><th>No Baut.</th><th>Total</th>
                        <th>Congregaciones</th><th>C. Blancos</th>
                        <th>Anc.</th><th>Diac.</th><th>Diaconi.</th><th>Hom.</th><th>Muj.</th>
                        <th>Ni√±os</th><th>Adol.</th><th>Jov.</th>
                        <th>Femenil</th><th>Juvenil</th><th>Caballero</th><th>Min. Infantil</th>
                        <th>Estado</th>
                    </tr>
                </thead>
                <tbody></tbody>
                <tfoot><tr id="fila-totales"></tr></tfoot>
            </table>
        </div>
    </div>
</div>

<div id="modal-nuevo" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.8); justify-content:center; align-items:center; z-index:200;">
    <div style="background:white; padding:25px; border-radius:8px; width:90%; max-width:400px; border:3px solid var(--dorado-metal);">
        <h3 style="color: var(--dorado-oscuro); margin-top:0;">NUEVO CONSEJO REGIONAL</h3>
        <input type="password" id="admin-pass" placeholder="Clave Maestra">
        <input type="text" id="new-name" placeholder="Nombre Consejo">
        <input type="tel" id="new-phone" placeholder="Tel√©fono Encargado">
        <input type="password" id="new-pass" placeholder="Contrase√±a Usuarios">
        <button class="btn-enviar" onclick="crearConsejo()">CREAR CONSEJO</button>
        <button onclick="cerrarModal()" style="width:100%; background:none; color:#777; border:none; margin-top:10px; cursor:pointer; font-weight: bold;">CANCELAR</button>
    </div>
</div>

<script>
    const API_URL = "https://script.google.com/macros/s/AKfycbzVPIfXv0TARCNXCGidgHS3AG2JXhLYlt2F2MzEA-tvMGgl4Xhl32el581Qtj5loxvDfQ/exec"; 
    let consejos = []; 
    let consejoActivo = null;
    let anioSeleccionado = new Date().getFullYear();
    let historialTotalGlobal = []; 

    document.addEventListener("DOMContentLoaded", () => {
        generarSelectorAnios();
        iniciarCargaSincronizada(); 
    });

    async function iniciarCargaSincronizada() {
        document.getElementById('barra-proceso').style.display = 'block';
        try {
            const r = await fetch(API_URL + "?accion=LEER_CONSEJOS&t=" + Date.now());
            consejos = await r.json();
            renderBotones();
            const promesas = consejos.map(c => 
                fetch(`${API_URL}?consejo=${encodeURIComponent(c.nombre)}&anio=${anioSeleccionado}`)
                .then(res => res.json())
            );
            const resultados = await Promise.all(promesas);
            historialTotalGlobal = resultados.flat(); 
            calcularInformeGeneral();
            if(consejoActivo) renderTabla();
        } catch(e) { console.error(e); }
        finally { document.getElementById('barra-proceso').style.display = 'none'; }
    }

    function generarSelectorAnios() {
        const sel = document.getElementById('selector-anio');
        const anioPartida = 2026;
        for(let i = anioPartida; i <= anioPartida + 20; i++) {
            let opt = document.createElement('option');
            opt.value = i; opt.text = "ESTADISTICA " + i;
            if(i == anioSeleccionado) opt.selected = true;
            sel.appendChild(opt);
        }
        actualizarEtiquetasAnio();
    }

    function actualizarEtiquetasAnio() {
        anioSeleccionado = document.getElementById('selector-anio').value;
        document.querySelectorAll('.anio-actual-txt').forEach(el => el.innerText = anioSeleccionado);
        verificarBloqueoAnio();
    }

    function verificarBloqueoAnio() {
        const actualReal = new Date().getFullYear();
        const btn = document.getElementById('btn-submit');
        const aviso = document.getElementById('aviso-bloqueo');
        const spanAnio = document.getElementById('span-anio-actual');
        if(spanAnio) spanAnio.innerText = actualReal;
        if (anioSeleccionado != actualReal) { btn.disabled = true; aviso.style.display = 'block'; } 
        else { btn.disabled = false; aviso.style.display = 'none'; }
    }

    function cambiarAnio() {
        anioSeleccionado = document.getElementById('selector-anio').value;
        actualizarEtiquetasAnio();
        document.getElementById('informe-content').style.display = 'none';
        iniciarCargaSincronizada(); 
    }

    function toggleInforme() {
        const content = document.getElementById('informe-content');
        content.style.display = (content.style.display === 'block') ? 'none' : 'block';
        document.getElementById('ojo-icono').innerText = (content.style.display === 'block') ? "CERRAR ‚ñ≥" : "VER DATOS ‚ñΩ";
        if(content.style.display === 'block') calcularInformeGeneral();
    }

    function renderBotones() {
        const div = document.getElementById('lista-botones');
        div.innerHTML = "";
        consejos.forEach(c => {
            let btn = document.createElement('button');
            btn.className = "btn-consejo";
            btn.innerHTML = `üèõÔ∏è ${c.nombre}`;
            btn.onclick = () => login(c.nombre, c.pass, c.phone);
            div.appendChild(btn);
        });
    }

    function login(nombre, passReal, phone) {
        let input = prompt(`Contrase√±a para ${nombre}:`);
        if (input === passReal) {
            consejoActivo = nombre;
            document.getElementById('encabezado-principal').style.display = 'none';
            document.getElementById('pantalla-inicio').style.display = 'none';
            document.getElementById('pantalla-formulario').style.display = 'block';
            document.getElementById('titulo-consejo').innerText = nombre;
            document.getElementById('link-encargado').innerText = `üìû ${phone || '5525-8033'}`;
            document.getElementById('link-encargado').href = `tel:${phone || '55258033'}`;
            renderTabla(); 
        }
    }

    function calcularInformeGeneral() {
        let t = { iglesias: 0, cong: 0, miem: 0, conv: 0, baut: 0, anc:0, diac:0, diaconi:0, hom:0, muj:0 };
        historialTotalGlobal.forEach(d => {
            if(d.tipoEntidad === "Iglesia") t.iglesias++; else if(d.tipoEntidad === "Congregacion") t.cong++;
            t.miem += Number(d.totalMiembros)||0; t.conv += Number(d.convertidos)||0;
            t.baut += Number(d.bautizados)||0; t.anc += Number(d.ancianos)||0;
            t.diac += Number(d.diaconos)||0; t.diaconi += Number(d.diaconisas)||0;
            t.hom += Number(d.hombres)||0; t.muj += Number(d.mujeres)||0;
        });
        document.getElementById('inf-iglesias').innerText = t.iglesias;
        document.getElementById('inf-congregaciones').innerText = t.cong;
        document.getElementById('inf-miembros').innerText = t.miem;
        document.getElementById('inf-convertidos').innerText = t.conv;
        document.getElementById('inf-bautizados').innerText = t.baut;
        document.getElementById('inf-ancianos').innerText = t.anc;
        document.getElementById('inf-diaconos').innerText = t.diac;
        document.getElementById('inf-diaconisas').innerText = t.diaconi;
        document.getElementById('inf-hombres').innerText = t.hom;
        document.getElementById('inf-mujeres').innerText = t.muj;
    }

    /* GUARDADO INMEDIATO EN LOCAL Y SUBIDA AUTOM√ÅTICA */
    function guardarDatos(e) {
        e.preventDefault();
        const tipo = document.getElementById('tipoEntidad').value;
        const mi = document.getElementById('minInfantil').value;
        if(!tipo || !mi) return alert("Debe seleccionar todas las opciones obligatorias.");
        
        document.getElementById('barra-proceso').style.display = 'block';
        
        const formData = new FormData(e.target);
        const data = Object.fromEntries(formData.entries());
        data.consejo = consejoActivo; 
        data.anio = anioSeleccionado;
        data.consejoSheet = consejoActivo; // Para informe global
        data.enviado = false; // Estado temporal

        // 1. Guardar en memoria local al instante
        historialTotalGlobal.push(data);
        renderTabla(); 
        calcularInformeGeneral();
        e.target.reset(); // Limpia formulario r√°pido

        // 2. Subir a la nube en segundo plano
        fetch(API_URL, { method: 'POST', mode: 'no-cors', body: JSON.stringify(data) })
        .then(() => { 
            iniciarCargaSincronizada(); // Actualiza todo autom√°ticamente al terminar
        })
        .finally(() => { 
            document.getElementById('barra-proceso').style.display = 'none'; 
        });
    }

    function renderTabla() {
        const tbody = document.querySelector('#tabla-registros tbody');
        const tfoot = document.getElementById('fila-totales');
        tbody.innerHTML = "";
        let s = { conv:0, baut:0, noBaut:0, tot:0, anc:0, diac:0, diaconi:0, hom:0, muj:0, nin:0, adol:0, jov:0 };
        
        const datosLocal = historialTotalGlobal.filter(h => h.consejoSheet === consejoActivo);
        
        datosLocal.forEach(d => {
            s.conv += Number(d.convertidos)||0; s.baut += Number(d.bautizados)||0; s.noBaut += Number(d.noBautizados)||0; s.tot += Number(d.totalMiembros)||0;
            s.anc += Number(d.ancianos)||0; s.diac += Number(d.diaconos)||0; s.diaconi += Number(d.diaconisas)||0;
            s.hom += Number(d.hombres)||0; s.muj += Number(d.mujeres)||0;
            s.nin += Number(d.ninos)||0; s.adol += Number(d.adolescentes)||0; s.jov += Number(d.jovenes)||0;

            tbody.innerHTML += `<tr>
                <td><button onclick="eliminarDato('${d.nombreIglesia}')" style="background:var(--danger);color:white;border:none;cursor:pointer;padding:5px;border-radius:4px;">üóëÔ∏è</button></td>
                <td>${d.tipoEntidad || '-'}</td><td><b>${d.nombreIglesia}</b></td><td>${d.direccion||'-'}</td><td>${d.telefono||'-'}</td>
                <td>${d.convertidos||0}</td><td>${d.bautizados||0}</td><td>${d.noBautizados||0}</td><td>${d.totalMiembros||0}</td>
                <td>${(d.congregaciones||"").replace(/\n/g,"<br>")}</td><td>${(d.camposBlancos||"").replace(/\n/g,"<br>")}</td>
                <td>${d.ancianos||0}</td><td>${d.diaconos||0}</td><td>${d.diaconisas||0}</td><td>${d.hombres||0}</td><td>${d.mujeres||0}</td>
                <td>${d.ninos||0}</td><td>${d.adolescentes||0}</td><td>${d.jovenes||0}</td>
                <td>${d.socFemenil||'-'}</td><td>${d.socJuvenil||'-'}</td><td>${d.socCaballero||'-'}</td><td>${d.minInfantil||'-'}</td>
                <td style="color:${d.enviado === false ? '#e67e22' : '#27ae60'}">${d.enviado === false ? '...' : 'OK'}</td>
            </tr>`;
        });
        tfoot.innerHTML = `<td colspan="5">TOTALES ${anioSeleccionado}</td><td>${s.conv}</td><td>${s.baut}</td><td>${s.noBaut}</td><td>${s.tot}</td><td colspan="2">-</td><td>${s.anc}</td><td>${s.diac}</td><td>${s.diaconi}</td><td>${s.hom}</td><td>${s.muj}</td><td>${s.nin}</td><td>${s.adol}</td><td>${s.jov}</td><td colspan="5">-</td>`;
    }

    function eliminarDato(nombre) {
        if (prompt("Clave Admin:") === "admin_2026") {
            document.getElementById('barra-proceso').style.display = 'block';
            fetch(API_URL, { method: 'POST', mode: 'no-cors', body: JSON.stringify({accion:"ELIMINAR_REGISTRO", consejo: consejoActivo, nombreIglesia: nombre, anio: anioSeleccionado}) })
            .then(() => { iniciarCargaSincronizada(); })
            .finally(() => { document.getElementById('barra-proceso').style.display = 'none'; });
        }
    }

    function volver() { 
        document.getElementById('encabezado-principal').style.display = 'block';
        document.getElementById('pantalla-formulario').style.display='none'; 
        document.getElementById('pantalla-inicio').style.display='block'; 
        iniciarCargaSincronizada(); 
    }
    function mostrarModal() { document.getElementById('modal-nuevo').style.display='flex'; }
    function cerrarModal() { document.getElementById('modal-nuevo').style.display='none'; }
    function crearConsejo() {
        if(document.getElementById('admin-pass').value !== "ESTADIS2026") return alert("Error");
        document.getElementById('barra-proceso').style.display = 'block';
        const payload = { accion: "CREAR_CONSEJO_GLOBAL", nombre: document.getElementById('new-name').value, phone: document.getElementById('new-phone').value, pass: document.getElementById('new-pass').value };
        fetch(API_URL, { method: 'POST', mode: 'no-cors', body: JSON.stringify(payload) })
        .then(() => { alert("Creado"); cerrarModal(); iniciarCargaSincronizada(); })
        .finally(() => { document.getElementById('barra-proceso').style.display = 'none'; });
    }
</script>
</body>
</html>
